{"version":3,"file":"formatCommaPositions.js","names":["maxLength","PRECEDING_WHITESPACE_REGEX","formatCommaPositions","query","commaPosition","indent","groupCommaDelimitedLines","split","flatMap","commaLines","length","formatTabular","formatBefore","Error","join","lines","groups","i","group","match","push","trimTrailingComments","map","line","indentComma","code","comment","spaces","repeat","trimTrailingCommas","whitespace","removeLastIndent","replace","trimStart","RegExp"],"sources":["../../src/formatter/formatCommaPositions.ts"],"sourcesContent":["import { CommaPosition } from '../FormatOptions.js';\nimport { maxLength } from '../utils.js';\n\nconst PRECEDING_WHITESPACE_REGEX = /^\\s+/u;\n\n/**\n * Handles comma placement - either before, after or tabulated\n */\nexport default function formatCommaPositions(\n  query: string,\n  commaPosition: CommaPosition,\n  indent: string\n): string {\n  return groupCommaDelimitedLines(query.split('\\n'))\n    .flatMap(commaLines => {\n      if (commaLines.length === 1) {\n        return commaLines;\n      } else if (commaPosition === 'tabular') {\n        return formatTabular(commaLines);\n      } else if (commaPosition === 'before') {\n        return formatBefore(commaLines, indent);\n      } else {\n        throw new Error(`Unexpected commaPosition: ${commaPosition}`);\n      }\n    })\n    .join('\\n');\n}\n\n/**\n * Given lines like this:\n *\n *     [\n *       'SELECT',\n *       '  foo,',\n *       '  bar, --comment',\n *       '  baz',\n *       'FROM'\n *     ]\n *\n * Returns groups like this:\n *\n *     [\n *       ['SELECT'],\n *       ['  foo,', '  bar, --comment', '  baz'],\n *       ['FROM']\n *     ]\n */\nfunction groupCommaDelimitedLines(lines: string[]): string[][] {\n  const groups: string[][] = [];\n  for (let i = 0; i < lines.length; i++) {\n    const group = [lines[i]];\n    // when line ends with comma,\n    // gather together all following lines that also end with comma,\n    // plus one (which doesn't end with comma)\n    while (lines[i].match(/.*,(\\s*(--.*)?$)/)) {\n      i++;\n      group.push(lines[i]);\n    }\n    groups.push(group);\n  }\n  return groups;\n}\n\n// makes all lines the same length by appending spaces before comma\nfunction formatTabular(commaLines: string[]): string[] {\n  const commaPosition = maxLength(trimTrailingComments(commaLines)) - 1;\n  return commaLines.map((line, i) => {\n    if (i === commaLines.length - 1) {\n      return line; // do not add comma for last item\n    }\n    return indentComma(line, commaPosition);\n  });\n}\n\nfunction indentComma(line: string, commaPosition: number) {\n  const [, code, comment] = line.match(/^(.*?),(\\s*--.*)?$/) || [];\n\n  const spaces = ' '.repeat(commaPosition - code.length);\n  return `${code}${spaces},${comment ?? ''}`;\n}\n\nfunction formatBefore(commaLines: string[], indent: string): string[] {\n  return trimTrailingCommas(commaLines).map((line, i) => {\n    if (i === 0) {\n      return line; // do not add comma for first item\n    }\n    const [whitespace] = line.match(PRECEDING_WHITESPACE_REGEX) || [''];\n    return (\n      removeLastIndent(whitespace, indent) +\n      indent.replace(/ {2}$/, ', ') + // add comma to the end of last indent\n      line.trimStart()\n    );\n  });\n}\n\nfunction removeLastIndent(whitespace: string, indent: string): string {\n  return whitespace.replace(new RegExp(indent + '$'), '');\n}\n\nfunction trimTrailingCommas(lines: string[]): string[] {\n  return lines.map(line => line.replace(/,(\\s*(--.*)?$)/, '$1'));\n}\n\nfunction trimTrailingComments(lines: string[]): string[] {\n  return lines.map(line => line.replace(/\\s*--.*/, ''));\n}\n"],"mappings":"AACA,SAASA,SAAT,QAA0B,aAA1B;AAEA,MAAMC,0BAA0B,GAAG,OAAnC;AAEA;AACA;AACA;;AACA,eAAe,SAASC,oBAAT,CACbC,KADa,EAEbC,aAFa,EAGbC,MAHa,EAIL;EACR,OAAOC,wBAAwB,CAACH,KAAK,CAACI,KAAN,CAAY,IAAZ,CAAD,CAAxB,CACJC,OADI,CACIC,UAAU,IAAI;IACrB,IAAIA,UAAU,CAACC,MAAX,KAAsB,CAA1B,EAA6B;MAC3B,OAAOD,UAAP;IACD,CAFD,MAEO,IAAIL,aAAa,KAAK,SAAtB,EAAiC;MACtC,OAAOO,aAAa,CAACF,UAAD,CAApB;IACD,CAFM,MAEA,IAAIL,aAAa,KAAK,QAAtB,EAAgC;MACrC,OAAOQ,YAAY,CAACH,UAAD,EAAaJ,MAAb,CAAnB;IACD,CAFM,MAEA;MACL,MAAM,IAAIQ,KAAJ,CAAW,6BAA4BT,aAAc,EAArD,CAAN;IACD;EACF,CAXI,EAYJU,IAZI,CAYC,IAZD,CAAP;AAaD;AAED;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AACA,SAASR,wBAAT,CAAkCS,KAAlC,EAA+D;EAC7D,MAAMC,MAAkB,GAAG,EAA3B;;EACA,KAAK,IAAIC,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAGF,KAAK,CAACL,MAA1B,EAAkCO,CAAC,EAAnC,EAAuC;IACrC,MAAMC,KAAK,GAAG,CAACH,KAAK,CAACE,CAAD,CAAN,CAAd,CADqC,CAErC;IACA;IACA;;IACA,OAAOF,KAAK,CAACE,CAAD,CAAL,CAASE,KAAT,CAAe,kBAAf,CAAP,EAA2C;MACzCF,CAAC;MACDC,KAAK,CAACE,IAAN,CAAWL,KAAK,CAACE,CAAD,CAAhB;IACD;;IACDD,MAAM,CAACI,IAAP,CAAYF,KAAZ;EACD;;EACD,OAAOF,MAAP;AACD,C,CAED;;;AACA,SAASL,aAAT,CAAuBF,UAAvB,EAAuD;EACrD,MAAML,aAAa,GAAGJ,SAAS,CAACqB,oBAAoB,CAACZ,UAAD,CAArB,CAAT,GAA8C,CAApE;EACA,OAAOA,UAAU,CAACa,GAAX,CAAe,CAACC,IAAD,EAAON,CAAP,KAAa;IACjC,IAAIA,CAAC,KAAKR,UAAU,CAACC,MAAX,GAAoB,CAA9B,EAAiC;MAC/B,OAAOa,IAAP,CAD+B,CAClB;IACd;;IACD,OAAOC,WAAW,CAACD,IAAD,EAAOnB,aAAP,CAAlB;EACD,CALM,CAAP;AAMD;;AAED,SAASoB,WAAT,CAAqBD,IAArB,EAAmCnB,aAAnC,EAA0D;EACxD,MAAM,GAAGqB,IAAH,EAASC,OAAT,IAAoBH,IAAI,CAACJ,KAAL,CAAW,oBAAX,KAAoC,EAA9D;EAEA,MAAMQ,MAAM,GAAG,IAAIC,MAAJ,CAAWxB,aAAa,GAAGqB,IAAI,CAACf,MAAhC,CAAf;EACA,OAAQ,GAAEe,IAAK,GAAEE,MAAO,IAAGD,OAAO,IAAI,EAAG,EAAzC;AACD;;AAED,SAASd,YAAT,CAAsBH,UAAtB,EAA4CJ,MAA5C,EAAsE;EACpE,OAAOwB,kBAAkB,CAACpB,UAAD,CAAlB,CAA+Ba,GAA/B,CAAmC,CAACC,IAAD,EAAON,CAAP,KAAa;IACrD,IAAIA,CAAC,KAAK,CAAV,EAAa;MACX,OAAOM,IAAP,CADW,CACE;IACd;;IACD,MAAM,CAACO,UAAD,IAAeP,IAAI,CAACJ,KAAL,CAAWlB,0BAAX,KAA0C,CAAC,EAAD,CAA/D;IACA,OACE8B,gBAAgB,CAACD,UAAD,EAAazB,MAAb,CAAhB,GACAA,MAAM,CAAC2B,OAAP,CAAe,OAAf,EAAwB,IAAxB,CADA,GACgC;IAChCT,IAAI,CAACU,SAAL,EAHF;EAKD,CAVM,CAAP;AAWD;;AAED,SAASF,gBAAT,CAA0BD,UAA1B,EAA8CzB,MAA9C,EAAsE;EACpE,OAAOyB,UAAU,CAACE,OAAX,CAAmB,IAAIE,MAAJ,CAAW7B,MAAM,GAAG,GAApB,CAAnB,EAA6C,EAA7C,CAAP;AACD;;AAED,SAASwB,kBAAT,CAA4Bd,KAA5B,EAAuD;EACrD,OAAOA,KAAK,CAACO,GAAN,CAAUC,IAAI,IAAIA,IAAI,CAACS,OAAL,CAAa,gBAAb,EAA+B,IAA/B,CAAlB,CAAP;AACD;;AAED,SAASX,oBAAT,CAA8BN,KAA9B,EAAyD;EACvD,OAAOA,KAAK,CAACO,GAAN,CAAUC,IAAI,IAAIA,IAAI,CAACS,OAAL,CAAa,SAAb,EAAwB,EAAxB,CAAlB,CAAP;AACD"}